$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "http://purl.org/iscc/schema/iscc-chunk-match.json"
title: "IsccChunkMatch"
type: object
description: |
  Segment-level similarity match result.

  Represents a matched asset based on simprint collisions/similarity. The overall
  score is computed using IDF-weighted averaging across all query simprints.

  **Score calculation**:
  - Each query simprint has an IDF weight computed from document frequency (freq)
  - IDF = log(total_assets / (1 + freq))
  - Matched simprints contribute: idf * similarity
  - Unmatched simprints contribute: idf * 0.0
  - Overall score = sum(contributions) / sum(all_idfs)

  **Example**: Query with 2 CONTENT + 3 SEMANTIC simprints (1000 total assets)
  - CONTENT: idf1=log(1000/43)=3.15, idf2=log(1000/51)=2.97
  - SEMANTIC: idf3=log(1000/87)=2.44, idf4=log(1000/123)=2.11, idf5=log(1000/201)=1.61
  - Type scores: CONTENT=(3.15*1.0+2.97*1.0)/(3.15+2.97)=1.0, SEMANTIC=(2.44*0.94+2.11*1.0+1.61*0.0)/(2.44+2.11+1.61)=0.72
  - Overall: (3.15*1.0+2.97*1.0+2.44*0.94+2.11*1.0+1.61*0.0)/12.28=0.88

  **Properties**:
  - Normalized 0.0-1.0 range (directly comparable)
  - IDF-weighted (rare simprints have more influence)
  - Accounts for partial matches (some simprints matched, others not)
required:
  - iscc_id
  - score
  - types
properties:
  iscc_id:
    type: string
    description: The matched ISCC-ID from the index
    pattern: "^ISCC:[A-Z2-7]{16,}$"
    example: "ISCC:MAIGIHZPQR7XKLAB"
  score:
    type: number
    description: |
      Overall IDF-weighted score (0.0-1.0).

      Computed as the weighted average of matched simprint similarities across
      all query simprints, with weights determined by IDF values (derived from
      document frequencies).

      Interpretation: "88% of query matched (by IDF weight)"
    minimum: 0.0
    maximum: 1.0
    example: 0.88
  types:
    type: object
    description: |
      Per-simprint-type match statistics. Keys are simprint type identifiers
      (e.g., "CONTENT_TEXT_V0", "SEMANTIC_TEXT_V0"), values are stat objects
      containing similarity, matches, queried counts, and optional chunk details.

      **Data locality**: Stats and chunks are co-located per type, enabling
      type-specific workflows (e.g., "show only semantic matches").

      **Missing keys**: Simprint types that were queried but had no matches
      are omitted.
    additionalProperties:
      type: object
      description: Match statistics and optional chunk details for a single simprint type
      required:
        - score
        - matches
        - queried
      properties:
        score:
          type: number
          description: |
            IDF-weighted score for this simprint type (0.0-1.0).
            Computed using the same formula as overall score but only
            for simprints of this type. IDF weights are derived from
            document frequencies (freq field in chunks).
          minimum: 0.0
          maximum: 1.0
          example: 0.954
        matches:
          type: integer
          description: |
            Number of query simprints of this type that found matches in this asset.
          minimum: 0
          example: 2
        queried:
          type: integer
          description: |
            Total number of query simprints of this type that were searched.
          minimum: 1
          example: 2
        chunks:
          type: array
          description: |
            Optional detailed list of matched chunks for this simprint type.

            Provides granular match information: which simprints matched, where they
            are located, similarity scores, and optional content preview.

            **Performance note**: This array can be large (100+ entries per type).
            Consider omitting or paginating for production use.

            **Note**: The simprint type is implicit from the parent dictionary key,
            so it's not included in individual chunk objects.
          items:
            $ref: "./IsccMatchedChunk.yaml"
    minProperties: 1
    example:
      CONTENT_TEXT_V0:
        score: 0.954
        matches: 2
        queried: 2
        chunks:
          - query: "AXvu3tp2kF8mN9qL4rT1sZ"
            match: "AXvu3tp2kF8mN9qL4rT1sZ"
            score: 1.0
            freq: 42
            offset: 12500
            size: 350
          - query: "B4kl9mQ1pP7xY3jH8vW2aF"
            match: "B4kl9mQ1pP7xY3jH8vW2aF"
            score: 1.0
            freq: 50
            offset: 45230
            size: 412
      SEMANTIC_TEXT_V0:
        score: 0.891
        matches: 2
        queried: 3
        chunks:
          - query: "CYhq2nR8oL3pT5mK9sX4bG"
            match: "CYhq3nR7oL2pT5mK9sX4bG"
            score: 0.94
            freq: 86
            offset: 78900
            size: 389
          - query: "D9mn7vT4qK2rU6nL1tY5cH"
            match: "D9mn7vT4qK2rU6nL1tY5cH"
            score: 1.0
            freq: 122
            offset: 123450
            size: 301
  source:
    type: string
    format: uri
    description: |
      Optional resolvable URL to the full content containing these chunks.
      Used for chunk retrieval workflow (source URI + offset/size).

      Supports various URI schemes via fsspec:
      - https:// - Standard HTTP(S) URLs
      - s3:// - AWS S3 buckets
      - file:// - Local filesystem
      - az:// - Azure Blob Storage
      - gs:// - Google Cloud Storage
    example: "https://example.com/9788899445566.epub"
  metadata:
    $ref: "./IsccMetadata.yaml"
    description: |
      Optional asset metadata, denormalized from the index for convenience.
example:
  iscc_id: "ISCC:MAIGIHZPQR7XKLAB"
  score: 0.88
  source: "https://example.com/9788899445566.epub"
  types:
    CONTENT_TEXT_V0:
      score: 1.0
      matches: 2
      queried: 2
      chunks:
        - query: "AXvu3tp2kF8mN9qL4rT1sZ"
          match: "AXvu3tp2kF8mN9qL4rT1sZ"
          score: 1.0
          freq: 42
          offset: 12500
          size: 350
        - query: "B4kl9mQ1pP7xY3jH8vW2aF"
          match: "B4kl9mQ1pP7xY3jH8vW2aF"
          score: 1.0
          freq: 50
          offset: 45230
          size: 412
    SEMANTIC_TEXT_V0:
      score: 0.72
      matches: 2
      queried: 3
      chunks:
        - query: "CYhq2nR8oL3pT5mK9sX4bG"
          match: "CYhq3nR7oL2pT5mK9sX4bG"
          score: 0.94
          freq: 86
          offset: 78900
          size: 389
        - query: "D9mn7vT4qK2rU6nL1tY5cH"
          match: "D9mn7vT4qK2rU6nL1tY5cH"
          score: 1.0
          freq: 122
          offset: 123450
          size: 301
  metadata:
    name: "Digital Philosophy: An Introduction"
    filename: "9788899445566.epub"
