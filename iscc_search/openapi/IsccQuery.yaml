$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "http://purl.org/iscc/schema/iscc-query.json"
title: "IsccQuery"
type: object
description: |
  Unified query format for ISCC search supporting three modes:

  1. **Global matching** (`iscc_code` or `units`): Match entire assets by ISCC-UNITs
  2. **Chunk matching** (`simprints`): Match content segments within assets
  3. **Combined** (both modes): Return both global_matches and chunk_matches

  **Requirement**: At least one of `iscc_id`, `iscc_code`, `units`, or `simprints` must be provided (validated at runtime).

  **Query modes**:
  - With `iscc_id`: Backend retrieves stored units and searches for similar assets ("find similar to this")
  - With `iscc_code` or `units`: Direct asset-level similarity search
  - With `simprints`: Segment-level similarity search
  - Combined: `iscc_code`/`units` + `simprints` returns both global and chunk matches

  **Query precedence**: If `iscc_id` is provided, it takes precedence - all other query
  fields (`iscc_code`, `units`, `simprints`) are ignored. This ensures clear semantics:
  "find assets similar to this specific indexed asset".

  **Query expansion**: When `iscc_id` is provided, the backend automatically retrieves
  the associated units from storage and uses them for similarity search.
properties:
  iscc_id:
    type: string
    description: |
      ISCC-ID of a known indexed asset to use as similarity reference. The backend
      retrieves the stored units for this ID and searches for similar assets.

      **Use case**: "Find assets similar to ISCC:MAI..." (more-like-this query)

      **Precedence**: When provided, `iscc_id` takes precedence over all other query
      fields. Any provided `iscc_code`, `units`, or `simprints` are ignored.

      **Behavior**:
      - Backend looks up iscc_id â†’ units in storage
      - Performs similarity search with those units
      - Returns matches excluding the query asset itself (no self-match)

      **Error handling**: Returns HTTP 404 if iscc_id is not found in the index.
    pattern: "^ISCC:[A-Z2-7]{16}$"
    example: "ISCC:MAIGIIFJRDGEQQAA"
  iscc_code:
    type: string
    description: |
      Composite ISCC-CODE combining multiple ISCC-UNITs. The system automatically
      extracts individual units for parallel search across unit-specific indexes.
    pattern: "^ISCC:[A-Z2-7]{16,}$"
    example: "ISCC:KADUHBUDQUT3LPWRJH6BUAG7HMBIXX6JRQRX3JH7EBIOSMXEVL5URBBUPOIOTU4HLSSQ"
  units:
    type: array
    description: |
      Explicit list of ISCC-UNITs for asset-level matching. Can be used instead of
      or in addition to `iscc_code` for fine-grained control over which units are queried.
    items:
      $ref: "./CommonProperties.yaml#/properties/iscc_unit"
    minItems: 1
    example:
      - "ISCC:AAAUHBUDQUT3LPWR"
      - "ISCC:CAAUT7A2ADPTWAUL"
      - "ISCC:EAA57SMMEN62J7ZA"
      - "ISCC:GAAVB2JS4SVPWSEE"
      - "ISCC:IAATI64Q5HJYOXFF"
  simprints:
    type: object
    description: |
      Simprint groups for chunk-level matching. Keys are simprint type identifiers
      (e.g., "CONTENT_TEXT_V0", "SEMANTIC_TEXT_V0", "INSTANCE_NONE_V0"), values are
      arrays of headerless base64-encoded simprints.

      **Simprint types** are versioned identifiers that determine:
      - Matching strategy (exact collision vs approximate similarity)
      - Abstraction level (semantic vs content vs data)
      - Segmentation approach (sentence chunks, embedding windows, etc.)

      **Extensibility**: New simprint types can be added without schema changes.
      Unknown types are ignored gracefully.

      **Common types**:
      - `CONTENT_TEXT_V0`: Lexical similarity (near-duplicates, minor edits)
      - `SEMANTIC_TEXT_V0`: Conceptual similarity (paraphrases, translations)
      - `INSTANCE_NONE_V0`: Exact bitstream matches (cryptographic identity)
    additionalProperties:
      type: array
      description: Array of base64-encoded simprint hashes (headerless, variable length)
      items:
        type: string
        description: |
          Base64-encoded simprint hash (url-safe or standard base64). Typical lengths:
          - 128-bit: 22 chars (base64url without padding)
          - 256-bit: 43 chars (base64 with padding) or 42 chars (without)
        pattern: "^[A-Za-z0-9+/_=-]+$"
        example: "AXvu3tp2kF8mN9qL4rT1sZ"
      minItems: 1
    example:
      CONTENT_TEXT_V0:
        - "AXvu3tp2kF8mN9qL4rT1sZ"
        - "B4kl9mQ1pP7xY3jH8vW2aF"
      SEMANTIC_TEXT_V0:
        - "CYhq2nR8oL3pT5mK9sX4bG"
        - "D9mn7vT4qK2rU6nL1tY5cH"
        - "E1pj8wU5rM9sV7oN2uZ6dJ"
example:
  iscc_code: "ISCC:KADUHBUDQUT3LPWRJH6BUAG7HMBIXX6JRQRX3JH7EBIOSMXEVL5URBBUPOIOTU4HLSSQ"
  units:
    - "ISCC:AAAUHBUDQUT3LPWR"
    - "ISCC:CAAUT7A2ADPTWAUL"
    - "ISCC:EAA57SMMEN62J7ZA"
    - "ISCC:GAAVB2JS4SVPWSEE"
    - "ISCC:IAATI64Q5HJYOXFF"
  simprints:
    CONTENT_TEXT_V0:
      - "AXvu3tp2kF8mN9qL4rT1sZ"
      - "B4kl9mQ1pP7xY3jH8vW2aF"
    SEMANTIC_TEXT_V0:
      - "CYhq2nR8oL3pT5mK9sX4bG"
      - "D9mn7vT4qK2rU6nL1tY5cH"
      - "E1pj8wU5rM9sV7oN2uZ6dJ"
