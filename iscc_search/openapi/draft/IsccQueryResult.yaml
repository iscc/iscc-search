$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "http://purl.org/iscc/schema/iscc-query-result.json"
title: "IsccQueryResult"
type: object
description: |
  Unified result format for ISCC similarity search queries.

  Contains the expanded query that was actually searched and matched assets at
  both asset-level (global_matches) and segment-level (chunk_matches).

  **Query expansion**: The echoed query shows the canonical expanded form that
  was actually searched:
  - If input had `iscc_id`: query.units contains the retrieved units
  - If input had `iscc_code`: query.units contains the extracted units
  - Simprints are echoed as-is

  **Result modes**:
  - Query with units only → global_matches populated, chunk_matches empty
  - Query with simprints only → chunk_matches populated, global_matches empty
  - Query with both → both arrays populated (same ISCC-ID can appear in both)

  **Ordering**: Matches are ordered by descending similarity (best matches first).
required:
  - query
properties:
  query:
    $ref: "./IsccQuery.yaml"
    description: |
      The expanded query that was actually searched.

      Shows the canonical form after backend processing:
      - `iscc_id` queries include the retrieved units
      - `iscc_code` queries include the extracted units
      - All fields reflect what was actually searched

      This provides full transparency into query expansion and backend behavior.
  global_matches:
    type: array
    description: |
      Asset-level similarity matches based on ISCC-UNIT matching.

      Ordered by descending score (best first). Empty if no units
      were queried or no matches found.
    items:
      $ref: "./IsccGlobalMatch.yaml"
    default: []
    example:
      - iscc_id: "ISCC:MAIGIHJYI3TRSMAB"
        score: 0.850
        types:
          META_NONE_V0: 1.0
          SEMANTIC_TEXT_V0: 1.0
          CONTENT_TEXT_V0: 1.0
          DATA_NONE_V0: 1.0
          INSTANCE_NONE_V0: 0.25
        metadata:
          name: "Cyberuomo"
          filename: "9788865882214.epub"
      - iscc_id: "ISCC:MAIGIHYPEHRMUMAB"
        score: 0.184
        types:
          SEMANTIC_TEXT_V0: 0.921875
        metadata:
          name: "Una piccola utopia"
          filename: "9788899126995.epub"
  chunk_matches:
    type: array
    description: |
      Segment-level similarity matches based on simprint matching.

      Ordered by descending score (best first). Empty if no simprints
      were queried or no matches found.

      **Note**: Chunks are nested within type stats per simprint type for
      data locality and type-specific access patterns.
    items:
      $ref: "./IsccChunkMatch.yaml"
    default: []
    example:
      - iscc_id: "ISCC:MAIGIHZPQR7XKLAB"
        score: 0.923
        types:
          CONTENT_TEXT_V0:
            score: 0.954
            matches: 2
            queried: 2
          SEMANTIC_TEXT_V0:
            score: 0.891
            matches: 2
            queried: 3
        metadata:
          name: "Digital Philosophy: An Introduction"
          filename: "9788899445566.epub"
      - iscc_id: "ISCC:MAIGIH3KSTMNPQAB"
        score: 0.487
        types:
          CONTENT_TEXT_V0:
            score: 0.487
            matches: 1
            queried: 2
        metadata:
          name: "The Virtual Society"
          filename: "9788877332211.epub"
example:
  query:
    iscc_code: "ISCC:KADUHBUDQUT3LPWRJH6BUAG7HMBIXX6JRQRX3JH7EBIOSMXEVL5URBBUPOIOTU4HLSSQ"
    units:
      - "ISCC:AAAUHBUDQUT3LPWR"
      - "ISCC:CAAUT7A2ADPTWAUL"
      - "ISCC:EAA57SMMEN62J7ZA"
      - "ISCC:GAAVB2JS4SVPWSEE"
      - "ISCC:IAATI64Q5HJYOXFF"
    simprints:
      CONTENT_TEXT_V0:
        - "AXvu3tp2kF8mN9qL4rT1sZ"
        - "B4kl9mQ1pP7xY3jH8vW2aF"
      SEMANTIC_TEXT_V0:
        - "CYhq2nR8oL3pT5mK9sX4bG"
        - "D9mn7vT4qK2rU6nL1tY5cH"
        - "E1pj8wU5rM9sV7oN2uZ6dJ"
  global_matches:
    - iscc_id: "ISCC:MAIGIHJYI3TRSMAB"
      score: 0.850
      types:
        META_NONE_V0: 1.0
        SEMANTIC_TEXT_V0: 1.0
        CONTENT_TEXT_V0: 1.0
        DATA_NONE_V0: 1.0
        INSTANCE_NONE_V0: 0.25
      metadata:
        name: "Cyberuomo"
        filename: "9788865882214.epub"
    - iscc_id: "ISCC:MAIGIHYPEHRMUMAB"
      score: 0.184
      types:
        SEMANTIC_TEXT_V0: 0.921875
      metadata:
        name: "Una piccola utopia"
        filename: "9788899126995.epub"
  chunk_matches:
    - iscc_id: "ISCC:MAIGIHZPQR7XKLAB"
      score: 0.923
      types:
        CONTENT_TEXT_V0:
          score: 0.954
          matches: 2
          queried: 2
          chunks:
            - query_simprint: "AXvu3tp2kF8mN9qL4rT1sZ"
              index_simprint: "AXvu3tp2kF8mN9qL4rT1sZ"
              simprint_type: "CONTENT_TEXT_V0"
              score: 1.0
              idf: 9.21
              offset: 12500
              size: 350
              source: "https://example.com/9788899445566.epub"
              modality: "text"
            - query_simprint: "B4kl9mQ1pP7xY3jH8vW2aF"
              index_simprint: "B4kl9mQ1pP7xY3jH8vW2aF"
              simprint_type: "CONTENT_TEXT_V0"
              score: 1.0
              idf: 8.76
              offset: 45230
              size: 412
              source: "https://example.com/9788899445566.epub"
              modality: "text"
        SEMANTIC_TEXT_V0:
          score: 0.891
          matches: 2
          queried: 3
          chunks:
            - query_simprint: "CYhq2nR8oL3pT5mK9sX4bG"
              index_simprint: "CYhq3nR7oL2pT5mK9sX4bG"
              simprint_type: "SEMANTIC_TEXT_V0"
              score: 0.94
              idf: 7.83
              offset: 78900
              size: 389
              source: "https://example.com/9788899445566.epub"
              modality: "text"
            - query_simprint: "D9mn7vT4qK2rU6nL1tY5cH"
              index_simprint: "D9mn7vT4qK2rU6nL1tY5cH"
              simprint_type: "SEMANTIC_TEXT_V0"
              score: 1.0
              idf: 6.54
              offset: 123450
              size: 301
              source: "https://example.com/9788899445566.epub"
              modality: "text"
      metadata:
        name: "Digital Philosophy: An Introduction"
        filename: "9788899445566.epub"
    - iscc_id: "ISCC:MAIGIH3KSTMNPQAB"
      score: 0.487
      types:
        CONTENT_TEXT_V0:
          score: 0.487
          matches: 1
          queried: 2
      metadata:
        name: "The Virtual Society"
        filename: "9788877332211.epub"
